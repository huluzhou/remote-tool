# 用户手册

本文档面向使用打包后的可执行文件的用户，介绍如何使用图形界面和配置文件。

## 快速开始

### 1. 启动程序

1. 确保 `query_tool.exe` 和 `csv_export_config.toml` 在同一目录下
2. 双击 `query_tool.exe` 启动程序
3. 首次启动可能需要几秒钟，请耐心等待

### 2. 基本使用流程

```
连接SSH → 配置查询 → 执行查询 → 查看结果 → 导出CSV
```

## 界面使用说明

### SSH连接配置

1. **填写SSH连接信息**：
   - SSH连接指令：格式为 `ssh 用户名@服务器地址 -p 端口号`
   - 密码：输入SSH登录密码（输入时会被隐藏显示）

2. **建立连接**：
   - 点击"连接"按钮
   - 等待连接状态显示为"已连接"（绿色）

### 数据库配置

- **数据库路径**：输入远程服务器上的数据库文件路径
  - 默认值：`/opt/analysis/data/device_data.db`
  - 根据实际情况修改为正确的路径

### 查询配置

1. **选择查询类型**：
   - 设备数据：查询设备运行数据（默认）
   - 指令数据：查询设备控制指令数据

2. **设备序列号**（可选）：
   - 留空：查询所有设备的数据
   - 填写：只查询指定设备的数据

3. **设置时间范围**：
   - **开始时间**：可直接输入时间戳，或使用快捷按钮（今天、昨天、最近7天）
   - **结束时间**：可直接输入时间戳，或使用"现在"按钮

4. **扩展表数据选项**（仅设备数据查询）：
   - 勾选：查询结果包含扩展字段
   - 不勾选：只查询主表字段

5. **执行查询**：点击"执行查询"按钮，查看结果预览

### 导出数据

1. 执行查询后，点击"导出为CSV"按钮
2. 选择保存路径
3. CSV文件特点：
   - 编码格式：UTF-8 with BOM（Excel可直接打开）
   - 时间格式：自动格式化为可读格式（东八区）
   - 字段过滤：只包含主表字段和配置文件中指定的扩展字段

### 保存配置

点击"保存配置"按钮，可以保存SSH连接信息、数据库路径和查询配置。下次启动程序时会自动加载。

## 配置文件使用说明

### 配置文件位置

配置文件 `csv_export_config.toml` 必须与 `query_tool.exe` 放在同一目录下。

### 配置项说明

#### 主表字段（main_table_fields）

这些字段会始终出现在CSV中。

```toml
main_table_fields = [
    "id", "device_sn", "device_type", "timestamp", 
    "local_timestamp", "activePower", "reactivePower", "powerFactor"
]
```

#### 扩展字段（extract_from_payload）

从 `payload_json` 中提取的字段，按设备类型分组配置。

```toml
[extract_from_payload]
# 电表设备类型
METER = [
    "activeEnergy",
    "reverseActiveEnergy",
    "ACfrequqncy",
    "apparentPower"
]

# 储能设备类型
STORAGE = [
    "TotalChgE",
    "TotalDisCE"
]

# 光伏设备类型
PV = []

# 充电桩设备类型
CHARGER = []

# 默认设备类型（未匹配到上述类型时使用）
default = []
```

#### 字段名映射（field_name_mapping）

将 JSON 中的字段名映射为 CSV 中的列名。

```toml
[field_name_mapping]
"SOC-BAT-001" = "soc"
"SOH-BAT-001" = "soh"
"internalT-PCS-001" = "internalT"
"radiatorT-PCS-001" = "radiatorT"
```

### 修改配置文件

1. 关闭程序（如果正在运行）
2. 使用文本编辑器打开 `csv_export_config.toml`
3. 修改相应配置项
4. 保存文件（确保使用UTF-8编码）
5. 重新启动程序，配置立即生效

## 常见问题

### Q1: 程序无法启动

**可能原因**：
- 缺少配置文件 `csv_export_config.toml`
- 杀毒软件阻止运行

**解决方法**：
1. 确保 `csv_export_config.toml` 与 `query_tool.exe` 在同一目录
2. 将程序目录添加到杀毒软件白名单

### Q2: SSH连接失败

**可能原因**：
- 服务器地址、端口、用户名或密码错误
- 网络不通
- 防火墙阻止

**解决方法**：
1. 检查SSH连接信息是否正确
2. 使用命令行测试SSH连接：`ssh user@host -p port`
3. 检查防火墙设置

### Q3: 查询失败

**可能原因**：
- 数据库路径不正确
- 数据库文件不存在
- 时间范围设置错误

**解决方法**：
1. 检查数据库路径是否正确
2. 确认数据库文件存在
3. 检查时间格式是否正确（时间戳或日期格式）

### Q4: CSV导出后字段不全

**可能原因**：
- 配置文件中未配置相应字段
- 设备类型不匹配

**解决方法**：
1. 检查 `csv_export_config.toml` 中是否配置了相应字段
2. 确认设备类型是否正确（METER、STORAGE、PV、CHARGER）

### Q5: CSV文件在Excel中乱码

**解决方法**：
1. 使用Excel 2016或更高版本
2. 如果仍乱码，使用Excel的"数据" → "从文本/CSV导入"功能
3. 在导入时选择UTF-8编码

### Q6: 时间格式说明

- `timestamp`：格式为 `YYYY-MM-DD HH:MM:SS`（东八区）
- `local_timestamp`：格式为 `YYYY/MM/DD H:MM:SS.000`（东八区，包含毫秒）

这是正常现象，程序会自动格式化时间戳。

## 时间格式参考

| 输入格式 | 示例 | 说明 |
|---------|------|------|
| 时间戳 | `1704067200` | Unix时间戳（秒） |
| 日期 | `2024-01-01` | 自动转换为当天00:00:00 |
| 日期时间 | `2024-01-01 12:00:00` | 完整日期时间 |
| 关键字 | `today` | 今天00:00:00 |
| 关键字 | `yesterday` | 昨天00:00:00 |
| 关键字 | `7days` | 7天前00:00:00 |
| 关键字 | `now` | 当前时间 |

## 设备类型说明

- **METER**：电表设备
- **STORAGE**：储能设备
- **PV**：光伏设备
- **CHARGER**：充电桩设备
