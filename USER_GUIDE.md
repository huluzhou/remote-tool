# 数据库查询工具 - 用户使用教程

本文档面向使用打包后的可执行文件的用户，介绍如何使用图形界面和配置文件。

## 目录

- [快速开始](#快速开始)
- [界面使用说明](#界面使用说明)
- [配置文件使用说明](#配置文件使用说明)
- [常见问题](#常见问题)

---

## 快速开始

### 1. 启动程序

1. 确保 `query_tool.exe` 和 `csv_export_config.toml` 在同一目录下
2. 双击 `query_tool.exe` 启动程序
3. 首次启动可能需要几秒钟，请耐心等待

### 2. 基本使用流程

```
连接SSH → 配置查询 → 执行查询 → 查看结果 → 导出CSV
```

---

## 界面使用说明

![alt text](image-1.png)

### 一、SSH连接配置

#### 1.1 填写SSH连接信息

在 **"SSH连接配置"** 区域：
![alt text](image.png)

- **SSH连接指令**：输入SSH连接命令
  
  - 格式：`ssh 用户名@服务器地址 -p 端口号`
  - 示例：`ssh zhou.zhang#root#720c334b-3b1f-4620-bbc4-0eba53ee9106@10.60.100.105 -p 2222`

- **密码**：输入SSH登录密码（输入时会被隐藏显示）

#### 1.2 建立连接

1. 点击 **"连接"** 按钮
2. 等待连接状态显示为 **"已连接"**（绿色）
3. 如果连接失败，状态会显示 **"未连接"**（红色），请检查：
   - 服务器地址和端口是否正确
   - 用户名和密码是否正确
   - 网络是否畅通

#### 1.3 连接状态说明

- **未连接**（红色）：尚未连接或连接失败
- **已连接**（绿色）：连接成功，可以进行查询操作

---

### 二、数据库配置

在 **"数据库配置"** 区域：

- **数据库路径**：输入远程服务器上的数据库文件路径
  - 默认值：`/mnt/analysis/data/device_data.db`
  - 根据实际情况修改为正确的路径

---

### 三、查询配置

#### 3.1 选择查询类型

在 **"查询配置"** 区域顶部，选择查询类型：

- **设备数据**：查询设备运行数据~~（默认）~~
- **指令数据**：查询设备控制指令数据
- **宽表数据**：查询所有设备数据<mark>(默认)</mark>

#### 3.2 设备序列号（<mark>必</mark>选）

- 如果留空：查询所有设备的数据
- 如果填写：只查询指定设备的数据
  - 示例：`THBESS0000AHDVJ73VPD2` 等

#### 3.3 设置时间范围

**开始时间**：

- 可以直接输入时间戳（如：`1704067200`）
- 或使用快捷按钮：
  - **今天**：设置为今天 00:00:00
  - **昨天**：设置为昨天 00:00:00
  - **最近7天**：设置为7天前的 00:00:00

**结束时间**：

- 可以直接输入时间戳
- 或使用快捷按钮：
  - **现在**：设置为当前时间

**时间格式说明**：

- 时间戳：`1704067200`（Unix时间戳，秒）
- 日期：`2024-01-01`
- 日期时间：`2024-01-01 12:00:00`

#### 3.4 扩展表数据选项（仅设备数据查询）

- **包含扩展表数据**（默认勾选）：
  - 勾选：查询结果包含扩展字段（从 payload_json 中提取）
  - 不勾选：只查询主表字段

#### 3.5 执行查询

1. 配置完成后，点击 **"执行查询"** 按钮
2. 查询结果会显示在下方的 **"查询结果"** 区域
3. 如果查询失败，会弹出错误提示

---

### 四、查看查询结果

#### 4.1 结果预览

查询结果以表格形式显示在 **"查询结果"** 区域：

- 使用滚动条查看完整结果
- 支持横向和纵向滚动
- 结果按时间从早到晚排序

#### 4.2 结果说明

- **设备数据查询**：显示设备运行数据，包含主表字段和扩展字段
- **指令数据查询**：显示设备控制指令数据

---

### 五、导出数据

#### 5.1 导出为CSV

1. 执行查询后，**"导出为CSV"** 按钮会变为可用状态
2. 点击 **"导出为CSV"** 按钮
3. 在弹出的文件保存对话框中：
   - 选择保存位置
   - 输入文件名（默认：`query_result_YYYYMMDD_HHMMSS.csv`）
   - 点击 **"保存"**

#### 5.2 CSV文件说明

导出的CSV文件特点：

- **编码格式**：UTF-8 with BOM（Excel可直接打开，不会乱码）
- **时间格式**：
  - `timestamp`：格式化为 `YYYY-MM-DD HH:MM:SS`（东八区）
  - `local_timestamp`：格式化为 `YYYY/MM/DD H:MM:SS.000`（东八区，包含毫秒）
- **字段过滤**：只包含主表字段和配置文件中指定的扩展字段
- **不包含**：`payload_json` 列（原始JSON数据）

#### 5.3 在Excel中打开

1. 双击CSV文件，用Excel打开
2. 如果出现乱码，在Excel中选择 **"数据" → "从文本/CSV导入"**，选择UTF-8编码
3. 建议使用Excel 2016或更高版本

---

### 六、保存配置

#### 6.1 保存当前配置

点击 **"保存配置"** 按钮，可以保存：

- SSH连接信息
  
  - 保存ssh地址和密码（用户名指定连接的资产和账号）后，后续登录可以直接使用，重复登录

- 数据库路径

- 查询配置
  
  #### 6.2 自动加载配置

下次启动程序时，会自动加载上次保存的配置。

---

### 七、部署/更新采集程序

![](C:\Users\zhou.zhang\AppData\Roaming\marktext\images\2026-01-08-10-20-03-image.png)

#### 7.1 部署配置

* 是否部署或者更新配置文件

* 是否部署或者更新拓扑文件
  
  > 当前拓扑文件是必须的，虽然现在宽表通过sn+字段名的方式确保了列名的唯一性，但是生成的时候需要从配置文件中获取需要从扩展表中提取的字段，而配置字段通过设备类型比较合理

* 部署后是否启动服务，启动的话会执行 
  
  ```bash
  systemctl start analysis-collector
  ```

* 部署日志：输出部署过程操作

* 文件路径：通过弹窗选择需要部署的可执行文件，每次修改会自动保存

--- 

## 配置文件使用说明

### 一、配置文件位置

配置文件 `csv_export_config.toml` 必须与 `query_tool.exe` 放在同一目录下。

```
程序目录/
├── query_tool.exe
└── csv_export_config.toml  ← 配置文件
```

### 二、配置文件格式

配置文件使用 TOML 格式，支持注释（以 `#` 开头）。

### 三、配置项说明

#### 3.1 主表字段（main_table_fields）

**说明**：这些字段会始终出现在CSV中。

**配置示例**：

```toml
main_table_fields = [
    "id",
    "device_sn",
    "device_type",
    "timestamp",
    "local_timestamp",
    "activePower",
    "reactivePower",
    "powerFactor"
]
```

**修改方法**：

- 添加字段：在列表中添加字段名（如：`"newField"`）
- 删除字段：从列表中移除字段名
- 调整顺序：改变列表中的顺序即可

#### 3.2 扩展字段（extract_from_payload）

**说明**：从 `payload_json` 中提取的字段，按设备类型分组配置。

**配置结构**：

```toml
[extract_from_payload]
# 电表设备类型
METER = [
    "activeEnergy",
    "reverseActiveEnergy",
    "ACfrequqncy",
    "apparentPower"
]

# 储能设备类型
STORAGE = [
    "TotalChgE",
    "TotalDisCE"
]

# 光伏设备类型
PV = [
    # "activePowerLimit",
    # "internalTemp"
]

# 充电桩设备类型
CHARGER = [
    # "OutP",
    # "needPower"
]

# 默认设备类型（未匹配到上述类型时使用）
default = []
```

**修改方法**：

1. **添加字段**：
   
   ```toml
   STORAGE = [
       "TotalChgE",
       "TotalDisCE",
       "SOC-BAT-001",  # 新增字段
       "SOH-BAT-001"   # 新增字段
   ]
   ```

2. **删除字段**：
   
   - 从列表中移除字段名
   - 或使用注释（在字段名前加 `#`）

3. **启用被注释的字段**：
   
   - 移除字段名前的 `#` 号

4. **添加新的设备类型**：
   
   ```toml
   [extract_from_payload]
   NEW_DEVICE_TYPE = [
       "field1",
       "field2"
   ]
   ```

#### 3.3 字段名映射（field_name_mapping）

**说明**：将 `payload_json` 中的字段名映射为CSV中的列名。

**配置示例**：

```toml
[field_name_mapping]
"SOC-BAT-001" = "soc"
"SOH-BAT-001" = "soh"
"internalT-PCS-001" = "internalT"
"radiatorT-PCS-001" = "radiatorT"
"cellTotalChgE-BAT-001" = "totalChargeEnergy"
"cellTotalDisCE-BAT-001" = "totalDischargeEnergy"
```

**使用场景**：

- JSON中的字段名太长或不易读（如：`SOC-BAT-001`）
- 希望CSV中的列名更简洁（如：`soc`）

**修改方法**：

1. **添加映射**：
   
   ```toml
   [field_name_mapping]
   "原始字段名" = "CSV列名"
   ```

2. **删除映射**：
   
   - 删除整行，或使用注释

3. **修改映射**：
   
   - 修改等号右侧的值

**注意事项**：

- 左侧的字段名必须与 `extract_from_payload` 中配置的字段名一致
- 右侧的列名会出现在CSV文件的表头中

---

### 四、配置示例

#### 示例1：为储能设备添加更多字段

```toml
[extract_from_payload]
STORAGE = [
    "TotalChgE",
    "TotalDisCE",
    "SOC-BAT-001",      # 新增：电池SOC
    "SOH-BAT-001",      # 新增：电池SOH
    "internalT-PCS-001", # 新增：内部温度
    "radiatorT-PCS-001"  # 新增：散热器温度
]

[field_name_mapping]
"SOC-BAT-001" = "soc"
"SOH-BAT-001" = "soh"
"internalT-PCS-001" = "internalT"
"radiatorT-PCS-001" = "radiatorT"
```

#### 示例2：只导出主表字段

```toml
[extract_from_payload]
METER = []
STORAGE = []
PV = []
CHARGER = []
default = []
```

#### 示例3：为所有设备类型添加通用字段

```toml
[extract_from_payload]
METER = ["activeEnergy"]
STORAGE = ["TotalChgE", "TotalDisCE"]
PV = ["dayActiveEnergy"]
CHARGER = ["chargeEnergy"]
default = ["commonField"]  # 未匹配设备类型时使用
```

---

### 五、配置文件修改步骤

1. **关闭程序**（如果正在运行）

2. **备份配置文件**（推荐）：
   
   ```
   复制 csv_export_config.toml → csv_export_config.toml.bak
   ```

3. **使用文本编辑器打开** `csv_export_config.toml`
   
   - 推荐使用：Notepad++、VS Code、记事本等
   - 确保使用UTF-8编码保存

4. **修改配置**：
   
   - 按照上述说明修改相应配置项
   - 注意保持TOML格式正确（括号、引号等）

5. **保存文件**

6. **重新启动程序**，配置立即生效

---

### 六、配置文件验证

#### 常见错误

1. **语法错误**：
   
   - 缺少引号：`METER = [activeEnergy]` ❌
   - 正确：`METER = ["activeEnergy"]` ✅

2. **格式错误**：
   
   - 缺少等号：`METER ["field"]` ❌
   - 正确：`METER = ["field"]` ✅

3. **编码问题**：
   
   - 确保文件以UTF-8编码保存
   - 避免使用Windows记事本（可能添加BOM）

#### 验证方法

1. 修改配置后，启动程序
2. 执行一次查询并导出CSV
3. 检查CSV文件中的列是否符合预期
4. 如果列名或数据不正确，检查配置文件格式

---

## 常见问题

### Q1: 程序无法启动

**可能原因**：

- 缺少配置文件 `csv_export_config.toml`
- 杀毒软件阻止运行

**解决方法**：

1. 确保 `csv_export_config.toml` 与 `query_tool.exe` 在同一目录
2. 将程序目录添加到杀毒软件白名单

---

### Q2: SSH连接失败

**可能原因**：

- 服务器地址、端口、用户名或密码错误
- 网络不通
- 防火墙阻止

**解决方法**：

1. 检查SSH连接信息是否正确
2. 使用命令行测试SSH连接：`ssh user@host -p port`
3. 检查防火墙设置

---

### Q3: 查询失败

**可能原因**：

- 数据库路径不正确
- 数据库文件不存在
- 时间范围设置错误

**解决方法**：

1. 检查数据库路径是否正确
2. 确认数据库文件存在
3. 检查时间格式是否正确（时间戳或日期格式）

---

### Q4: CSV导出后字段不全

**可能原因**：

- 配置文件中未配置相应字段
- 设备类型不匹配

**解决方法**：

1. 检查 `csv_export_config.toml` 中是否配置了相应字段
2. 确认设备类型是否正确（METER、STORAGE、PV、CHARGER）
3. 查看查询结果中的 `device_type` 字段，确认设备类型

---

### Q5: CSV文件在Excel中乱码

**解决方法**：

1. 使用Excel 2016或更高版本
2. 如果仍乱码，使用Excel的 **"数据" → "从文本/CSV导入"** 功能
3. 在导入时选择UTF-8编码

---

### Q6: 修改配置文件后不生效

**解决方法**：

1. 确保文件保存为UTF-8编码
2. 检查TOML格式是否正确
3. 重新启动程序
4. 检查配置文件是否与exe在同一目录

---

### Q7: 时间戳格式不正确

**说明**：

- `timestamp`：格式为 `YYYY-MM-DD HH:MM:SS`（东八区）
- `local_timestamp`：格式为 `YYYY/MM/DD H:MM:SS.000`（东八区，包含毫秒）

如果格式不符合预期，这是正常现象，程序会自动格式化时间戳。

---

### Q8: 如何查看所有可用字段

**方法**：

1. 在查询配置中，取消勾选 **"包含扩展表数据"**
2. 执行查询，查看结果中的字段
3. 或者勾选 **"包含扩展表数据"**，查看 `payload_json` 中的字段（需要解析JSON）

---

## 技术支持

如遇到其他问题，请：

1. 检查配置文件格式是否正确
2. 查看程序运行时的错误提示
3. 联系技术支持并提供：
   - 错误信息截图
   - 配置文件内容
   - 操作步骤

---

## 附录

### 时间格式参考

| 输入格式 | 示例                    | 说明              |
| ---- | --------------------- | --------------- |
| 时间戳  | `1704067200`          | Unix时间戳（秒）      |
| 日期   | `2024-01-01`          | 自动转换为当天00:00:00 |
| 日期时间 | `2024-01-01 12:00:00` | 完整日期时间          |
| 关键字  | `today`               | 今天00:00:00      |
| 关键字  | `yesterday`           | 昨天00:00:00      |
| 关键字  | `7days`               | 7天前00:00:00     |
| 关键字  | `now`                 | 当前时间            |

### 设备类型说明

- **METER**：电表设备
- **STORAGE**：储能设备
- **PV**：光伏设备
- **CHARGER**：充电桩设备

### CSV文件列说明

**主表字段**（始终存在）：

- `id`：记录ID
- `device_sn`：设备序列号
- `device_type`：设备类型
- `timestamp`：设备时间戳（格式化后）
- `local_timestamp`：本地时间戳（格式化后，包含毫秒）
- `activePower`：有功功率
- `reactivePower`：无功功率
- `powerFactor`：功率因数

**扩展字段**（根据配置文件提取）：

- 从 `payload_json` 中提取的字段
- 字段名可能经过映射（根据 `field_name_mapping` 配置）

---

**文档版本**：1.1  
**最后更新**：2025.1.8
