name: Build Windows Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # 允许手动触发

env:
  PYTHON_VERSION: '3.12'

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    permissions:
      contents: write  # 需要此权限来创建 Release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Upgrade pip
      run: python -m pip install --upgrade pip
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Generate version info
      id: version
      shell: pwsh
      run: |
        $buildDate = Get-Date -Format "yyyyMMdd_HHmmss"
        $gitCommit = git rev-parse --short HEAD
        $gitBranch = git rev-parse --abbrev-ref HEAD
        $version = "${buildDate}_${gitCommit}"
        
        @"
        BUILD_DATE=$buildDate
        GIT_COMMIT=$gitCommit
        GIT_BRANCH=$gitBranch
        VERSION=$version
        "@ | Out-File -FilePath version.txt -Encoding utf8
        
        "BUILD_DATE=$buildDate" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "GIT_COMMIT=$gitCommit" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "GIT_BRANCH=$gitBranch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        
        Write-Host "Version: $version"
        Write-Host "Branch: $gitBranch"
        Write-Host "Commit: $gitCommit"
    
    - name: Clean build directories
      shell: pwsh
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        if (Test-Path dist) { Remove-Item -Recurse -Force dist }
    
    - name: Build GUI executable
      run: |
        python -m PyInstaller build_windows.spec --clean --noconfirm
    
    # - name: Build CLI executable
    #   shell: pwsh
    #   run: |
    #     if (Test-Path build_windows_cli.spec) {
    #       python -m PyInstaller build_windows_cli.spec --clean --noconfirm
    #     } else {
    #       Write-Host "CLI spec file not found, skipping CLI build"
    #     }
    #   continue-on-error: true
    
    - name: Verify build artifacts
      shell: pwsh
      run: |
        if (-not (Test-Path "dist\query_tool.exe")) {
          Write-Error "Build failed: query_tool.exe not found"
          exit 1
        }
        Write-Host "✓ GUI version built successfully"
        
        if (Test-Path "dist\query_tool_cli.exe") {
          Write-Host "✓ CLI version built successfully"
        }
        
        Get-ChildItem dist\*.exe | ForEach-Object {
          Write-Host "  - $($_.Name): $([math]::Round($_.Length / 1MB, 2)) MB"
        }
    
    - name: Create executable package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $buildDate = "${{ steps.version.outputs.BUILD_DATE }}"
        $gitCommit = "${{ steps.version.outputs.GIT_COMMIT }}"
        
        # 创建可执行文件包目录
        $executableDir = "dist\executable"
        New-Item -ItemType Directory -Force -Path $executableDir | Out-Null
        
        # 复制可执行文件
        Copy-Item dist\query_tool.exe $executableDir\ -Force
        
        # 复制配置文件
        if (Test-Path csv_export_config.toml) {
          Copy-Item csv_export_config.toml $executableDir\ -Force
        }
        if (Test-Path version.txt) {
          Copy-Item version.txt $executableDir\ -Force
        }
        
        # 创建 README
        $readme = @"
        Query Tool Release Package
        Version: $version
        Build Date: $buildDate
        Git Commit: $gitCommit
        
        Files:
        - query_tool.exe: GUI version
        - csv_export_config.toml: Configuration file
        - version.txt: Version information
        
        Usage:
        1. Extract all files to the same directory
        2. Double-click query_tool.exe to run GUI version
        
        Note:
        - First run may take a few seconds to start
        - Some antivirus software may report false positives, add to whitelist if needed
        - For detailed usage instructions, see USER_GUIDE.md
        "@
        $readme | Out-File -FilePath "$executableDir\README.txt" -Encoding utf8
        
        Write-Host "✓ Executable package created in $executableDir"
    
    - name: Create executable archive
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $executableZipName = "query-tool-windows-$version.zip"
        $executableDir = "dist\executable"
        
        # 查找 7z 可执行文件路径
        # GitHub Actions Windows runner 通常已预装 7-Zip
        $7zPaths = @(
          "C:\Program Files\7-Zip\7z.exe",
          "${env:ProgramFiles}\7-Zip\7z.exe",
          "${env:ProgramFiles(x86)}\7-Zip\7z.exe"
        )
        
        $7zPath = $null
        foreach ($path in $7zPaths) {
          if (Test-Path $path) {
            $7zPath = $path
            break
          }
        }
        
        # 尝试通过 PATH 查找
        if (-not $7zPath) {
          $7zCmd = Get-Command 7z -ErrorAction SilentlyContinue
          if ($7zCmd) {
            $7zPath = $7zCmd.Source
          }
        }
        
        if (-not $7zPath) {
          Write-Error "7-Zip not found. GitHub Actions Windows runner should have 7-Zip pre-installed."
          exit 1
        }
        
        Write-Host "Using 7-Zip at: $7zPath"
        
        # 使用 7z 创建压缩包（使用 zip 格式以保持兼容性，最大压缩级别）
        # -mx=9: 最大压缩级别
        # -mm=Deflate: 使用 Deflate 压缩方法（zip 标准）
        # -mmt=on: 启用多线程压缩
        # -mfb=258: 快速字节数（提高压缩率）
        & $7zPath a -tzip -mx=9 -mm=Deflate -mmt=on -mfb=258 "dist\$executableZipName" "$executableDir\*"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to create archive with 7z (exit code: $LASTEXITCODE)"
          exit 1
        }
        
        Write-Host "✓ Executable archive created: $executableZipName"
        Get-Item "dist\$executableZipName" | ForEach-Object {
          Write-Host "  - Size: $([math]::Round($_.Length / 1MB, 2)) MB"
        }
    
    - name: Create release directory
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $releaseDir = "dist\release"
        New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null
        
        # 复制可执行文件压缩包到 release 目录
        Copy-Item "dist\query-tool-windows-$version.zip" $releaseDir\ -Force
        
        Write-Host "✓ Release directory created with archive"
        Get-ChildItem $releaseDir | ForEach-Object {
          Write-Host "  - $($_.Name): $([math]::Round($_.Length / 1MB, 2)) MB"
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: query-tool-${{ steps.version.outputs.VERSION }}
        path: |
          dist/release/*
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/release/query-tool-windows-*.zip
        name: Release ${{ github.ref_name }}
        body: |
          ## Query Tool ${{ github.ref_name }}
          
          **Build Information:**
          - Build Date: ${{ steps.version.outputs.BUILD_DATE }}
          - Git Commit: ${{ steps.version.outputs.GIT_COMMIT }}
          - Git Branch: ${{ steps.version.outputs.GIT_BRANCH }}
          
          **Installation:**
          1. 下载 `query-tool-windows-*.zip` 文件
          2. 解压到任意目录
          3. 双击运行 `query_tool.exe`
          
          **文件包包含:**
          - `query_tool.exe` - GUI 版本
          - `csv_export_config.toml` - 配置文件
          - `version.txt` - 版本信息
          - `README.txt` - 使用说明
          
          For detailed usage instructions, see [USER_GUIDE.md](USER_GUIDE.md).
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
