name: Build Windows Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # 允许手动触发

env:
  PYTHON_VERSION: '3.12'

jobs:
  build:
    name: Build Windows Executable
    runs-on: windows-latest
    permissions:
      contents: write  # 需要此权限来创建 Release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Upgrade pip
      run: python -m pip install --upgrade pip
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Generate version info
      id: version
      shell: pwsh
      run: |
        $buildDate = Get-Date -Format "yyyyMMdd_HHmmss"
        $gitCommit = git rev-parse --short HEAD
        $gitBranch = git rev-parse --abbrev-ref HEAD
        $version = "${buildDate}_${gitCommit}"
        
        @"
        BUILD_DATE=$buildDate
        GIT_COMMIT=$gitCommit
        GIT_BRANCH=$gitBranch
        VERSION=$version
        "@ | Out-File -FilePath version.txt -Encoding utf8
        
        "BUILD_DATE=$buildDate" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "GIT_COMMIT=$gitCommit" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "GIT_BRANCH=$gitBranch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        
        Write-Host "Version: $version"
        Write-Host "Branch: $gitBranch"
        Write-Host "Commit: $gitCommit"
    
    - name: Clean build directories
      shell: pwsh
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        if (Test-Path dist) { Remove-Item -Recurse -Force dist }
    
    - name: Build GUI executable
      run: |
        python -m PyInstaller build_windows.spec --clean --noconfirm
    
    - name: Build CLI executable
      shell: pwsh
      run: |
        if (Test-Path build_windows_cli.spec) {
          python -m PyInstaller build_windows_cli.spec --clean --noconfirm
        } else {
          Write-Host "CLI spec file not found, skipping CLI build"
        }
      continue-on-error: true
    
    - name: Verify build artifacts
      shell: pwsh
      run: |
        if (-not (Test-Path "dist\query_tool.exe")) {
          Write-Error "Build failed: query_tool.exe not found"
          exit 1
        }
        Write-Host "✓ GUI version built successfully"
        
        if (Test-Path "dist\query_tool_cli.exe") {
          Write-Host "✓ CLI version built successfully"
        }
        
        Get-ChildItem dist\*.exe | ForEach-Object {
          Write-Host "  - $($_.Name): $([math]::Round($_.Length / 1MB, 2)) MB"
        }
    
    - name: Create release package
      shell: pwsh
      run: |
        $releaseDir = "dist\release"
        New-Item -ItemType Directory -Force -Path $releaseDir | Out-Null
        
        # Copy executables
        Copy-Item dist\query_tool.exe $releaseDir\ -Force
        if (Test-Path dist\query_tool_cli.exe) {
          Copy-Item dist\query_tool_cli.exe $releaseDir\ -Force
        }
        
        # Copy configuration files
        if (Test-Path csv_export_config.toml) {
          Copy-Item csv_export_config.toml $releaseDir\ -Force
        }
        if (Test-Path version.txt) {
          Copy-Item version.txt $releaseDir\ -Force
        }
        
        # Create README
        $version = "${{ steps.version.outputs.VERSION }}"
        $buildDate = "${{ steps.version.outputs.BUILD_DATE }}"
        $gitCommit = "${{ steps.version.outputs.GIT_COMMIT }}"
        
        $readme = @"
        Query Tool Release Package
        Version: $version
        Build Date: $buildDate
        Git Commit: $gitCommit
        
        Files:
        - query_tool.exe: GUI version
        - query_tool_cli.exe: CLI version (if available)
        - csv_export_config.toml: Configuration file
        - version.txt: Version information
        
        Usage:
        1. Extract all files to the same directory
        2. Double-click query_tool.exe to run GUI version
        3. Or run query_tool_cli.exe --help in command line
        
        Note:
        - First run may take a few seconds to start
        - Some antivirus software may report false positives, add to whitelist if needed
        - For detailed usage instructions, see USER_GUIDE.md
        "@
        $readme | Out-File -FilePath "$releaseDir\README.txt" -Encoding utf8
        
        Write-Host "✓ Release package created in $releaseDir"
    
    - name: Create ZIP archive
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $zipName = "query-tool-windows-$version.zip"
        $releaseDir = "dist\release"
        
        # Create ZIP file
        Compress-Archive -Path "$releaseDir\*" -DestinationPath "dist\$zipName" -Force
        
        Write-Host "✓ ZIP archive created: $zipName"
        Get-Item "dist\$zipName" | ForEach-Object {
          Write-Host "  - Size: $([math]::Round($_.Length / 1MB, 2)) MB"
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: query-tool-${{ steps.version.outputs.VERSION }}
        path: |
          dist/query-tool-windows-*.zip
          dist/release/*
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/query-tool-windows-*.zip
        name: Release ${{ github.ref_name }}
        body: |
          ## Query Tool ${{ github.ref_name }}
          
          **Build Information:**
          - Build Date: ${{ steps.version.outputs.BUILD_DATE }}
          - Git Commit: ${{ steps.version.outputs.GIT_COMMIT }}
          - Git Branch: ${{ steps.version.outputs.GIT_BRANCH }}
          
          **Installation:**
          1. Download the ZIP file
          2. Extract to any directory
          3. Run `query_tool.exe`
          
          **Files included:**
          - `query_tool.exe` - GUI version
          - `query_tool_cli.exe` - CLI version (if available)
          - `csv_export_config.toml` - Configuration file
          - `version.txt` - Version information
          - `README.txt` - Usage instructions
          
          For detailed usage instructions, see [USER_GUIDE.md](USER_GUIDE.md).
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
