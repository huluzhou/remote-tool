name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write  # 需要写入权限来创建 Release 和上传文件

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install frontend dependencies
        run: npm install

      - name: Build the app (installer)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: ./
          tagName: ${{ github.ref_name }}
          releaseName: 'Remote Tool ${{ github.ref_name }}'
          releaseBody: |
            ## Remote Tool ${{ github.ref_name }}
            
            **Build Information:**
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Git Commit: ${{ github.sha }}
            
            **安装方式:**
            
            **方式 1：安装包（推荐）**
            1. 下载 `remote-tool_*.exe` 安装包
            2. 运行安装包进行安装
            3. 从开始菜单启动应用
            
            **方式 2：便携版（免安装）**
            1. 下载 `remote-tool-portable-*.zip` 压缩包
            2. 解压到任意目录
            3. 直接运行 `remote-tool.exe` 即可
            
            **功能:**
            - 数据查询：通过SSH连接远程服务器查询SQLite数据库
            - 应用部署：通过SSH部署应用程序到远程服务器
            - 自动更新：支持从GitHub Releases自动更新
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          updaterJsonPreferNsis: true
          args: --target x86_64-pc-windows-msvc

      - name: Collect files for portable package
        shell: powershell
        run: |
          $targetDir = "src-tauri\target\x86_64-pc-windows-msvc\release"
          $exePath = "$targetDir\remote-tool.exe"
          
          # 创建临时目录用于打包
          $packageDir = "portable-package"
          New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
          
          # 复制可执行文件
          if (Test-Path $exePath) {
            Copy-Item $exePath $packageDir\remote-tool.exe
            Write-Host "已复制可执行文件: remote-tool.exe"
          } else {
            Write-Error "可执行文件不存在: $exePath"
            exit 1
          }
          
          # 检查可执行文件目录中是否有其他 DLL（Tauri 可能会生成一些 DLL）
          $dllFiles = Get-ChildItem -Path $targetDir -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($dllFiles) {
            foreach ($dll in $dllFiles) {
              Copy-Item $dll.FullName $packageDir\
              Write-Host "已复制 DLL: $($dll.Name)"
            }
          } else {
            Write-Host "未发现额外的 DLL 文件（这是正常的，Rust 程序通常静态链接）"
          }
          
          # 检查是否有其他必要的文件（如配置文件等）
          $otherFiles = @("*.toml", "*.json", "*.yaml", "*.yml")
          foreach ($pattern in $otherFiles) {
            $files = Get-ChildItem -Path $targetDir -Filter $pattern -ErrorAction SilentlyContinue
            if ($files) {
              foreach ($file in $files) {
                Copy-Item $file.FullName $packageDir\
                Write-Host "已复制配置文件: $($file.Name)"
              }
            }
          }
          
          Write-Host "`n打包文件列表:"
          Get-ChildItem -Path $packageDir | ForEach-Object { 
            $size = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  - $($_.Name) ($size MB)" 
          }

      - name: Create portable zip package
        shell: powershell
        run: |
          $packageDir = "portable-package"
          $zipName = "remote-tool-portable-${{ github.ref_name }}.zip"
          
          # 创建压缩包
          Compress-Archive -Path "$packageDir\*" -DestinationPath $zipName -Force
          
          $zipSize = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
          Write-Host "已创建压缩包: $zipName ($zipSize MB)"

      - name: Upload portable package to release
        uses: softprops/action-gh-release@v1
        with:
          files: remote-tool-portable-*.zip
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
