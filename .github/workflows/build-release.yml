name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write  # 需要写入权限来创建 Release 和上传文件

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install frontend dependencies
        run: npm install

      - name: Build portable app
        run: npm run tauri build -- --target x86_64-pc-windows-msvc
        shell: bash

      - name: Package portable app
        shell: powershell
        run: |
          $targetDir = "src-tauri\target\x86_64-pc-windows-msvc\release"
          $exePath = "$targetDir\remote-tool.exe"
          $zipName = "remote-tool-portable-${{ github.ref_name }}.zip"
          
          # Check if executable exists
          if (-not (Test-Path $exePath)) {
            Write-Error "Executable not found: $exePath"
            exit 1
          }
          
          Write-Host "Found executable: remote-tool.exe"
          $exeSize = [math]::Round((Get-Item $exePath).Length / 1MB, 2)
          Write-Host "File size: $exeSize MB"
          
          # Create temporary directory for packaging
          $packageDir = "portable-package"
          New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
          
          # Copy executable
          Copy-Item $exePath "$packageDir\remote-tool.exe"
          
          # Check and copy DLL files if any
          $dllFiles = Get-ChildItem -Path $targetDir -Filter "*.dll" -ErrorAction SilentlyContinue
          if ($dllFiles) {
            foreach ($dll in $dllFiles) {
              Copy-Item $dll.FullName $packageDir\
              Write-Host "Copied DLL: $($dll.Name)"
            }
          } else {
            Write-Host "No additional DLL files found (this is normal, Rust programs are usually statically linked)"
          }
          
          # Create zip archive
          Compress-Archive -Path "$packageDir\*" -DestinationPath $zipName -Force
          
          $zipSize = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
          Write-Host "Created portable package: $zipName ($zipSize MB)"
          
          # List zip contents
          Write-Host ""
          Write-Host "Zip contents:"
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          $zip = [System.IO.Compression.ZipFile]::OpenRead($zipName)
          $zip.Entries | ForEach-Object { Write-Host "  - $($_.FullName)" }
          $zip.Dispose()
          
          # Cleanup temporary directory
          Remove-Item -Path $packageDir -Recurse -Force

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: 'Remote Tool ${{ github.ref_name }}'
          body: |
            ## Remote Tool ${{ github.ref_name }}
            
            **Build Information:**
            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Git Commit: ${{ github.sha }}
            
            **使用方式（便携版）:**
            1. 下载 `remote-tool-portable-*.zip` 压缩包
            2. 解压到任意目录
            3. 直接运行 `remote-tool.exe` 即可（无需安装）
            
            **功能:**
            - 数据查询：通过SSH连接远程服务器查询SQLite数据库
            - 应用部署：通过SSH部署应用程序到远程服务器
          files: remote-tool-portable-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
